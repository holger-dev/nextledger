name: Build and publish Nextcloud app release

on:
  release:
    types: [published]

permissions:
  contents: write

env:
  APP_NAME: nextledger

jobs:
  build_and_publish:
    environment: release
    runs-on: ubuntu-latest

    strategy:
      matrix:
        php-versions: ['8.2']
        nextcloud: ['stable32']
        database: ['sqlite']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Build frontend (webpack -> apps/nextledger/js)
        run: |
          npm ci
          npm run build

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-versions }}
          extensions: pdo_sqlite,pdo_mysql,pdo_pgsql,gd,zip
          coverage: none

      - name: Set up Nextcloud server
        uses: SMillerDev/nextcloud-actions/setup-nextcloud@fae87e29aa7cdf1ea0b8033c67f60e75b10be2cd
        with:
          cron: false
          version: ${{ matrix.nextcloud }}
          database-type: ${{ matrix.database }}

      - name: Prepare release app workspace
        run: |
          mkdir -p ../release-app/${{ env.APP_NAME }}
          rsync -a --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "node_modules" \
            --chmod=Du=rwx,Dgo=rx,Fu=rw,Fgo=r \
            ./apps/${{ env.APP_NAME }}/ \
            ../release-app/${{ env.APP_NAME }}/

      - name: Install PHP dependencies (composer --no-dev)
        run: |
          cd ../release-app/${{ env.APP_NAME }}
          if [ -f composer.json ]; then
            composer install --no-dev --prefer-dist --optimize-autoloader
          fi

      - name: Write certificate and key from secrets
        run: |
          mkdir -p ~/.nextcloud/certificates
          printf "%s" "${{ secrets.APP_PRIVATE_KEY }}" > ~/.nextcloud/certificates/${{ env.APP_NAME }}.key
          printf "%s" "${{ secrets.APP_PUBLIC_CRT }}"  > ~/.nextcloud/certificates/${{ env.APP_NAME }}.crt
          # Normalize accidental Windows line endings from copied secrets.
          sed -i 's/\r$//' ~/.nextcloud/certificates/${{ env.APP_NAME }}.key
          sed -i 's/\r$//' ~/.nextcloud/certificates/${{ env.APP_NAME }}.crt
          chmod 600 ~/.nextcloud/certificates/${{ env.APP_NAME }}.key
          chmod 644 ~/.nextcloud/certificates/${{ env.APP_NAME }}.crt

      - name: Validate app signing key/certificate
        run: |
          KEY=~/.nextcloud/certificates/${{ env.APP_NAME }}.key
          CRT=~/.nextcloud/certificates/${{ env.APP_NAME }}.crt

          # Parse checks: fail early with clear error if secrets are malformed.
          openssl pkey -in "$KEY" -noout >/dev/null
          openssl x509 -in "$CRT" -noout >/dev/null

          KEY_FP="$(openssl pkey -in "$KEY" -pubout -outform PEM | openssl dgst -sha256 | sed 's/^.*= //')"
          CRT_FP="$(openssl x509 -in "$CRT" -pubkey -noout | openssl pkey -pubin -outform PEM | openssl dgst -sha256 | sed 's/^.*= //')"
          if [ "$KEY_FP" != "$CRT_FP" ]; then
            echo "Private key and certificate do not match."
            echo "Please update APP_PRIVATE_KEY / APP_PUBLIC_CRT with a matching pair."
            exit 1
          fi

      - name: Create signed release archive (make appstore)
        run: |
          cd ../release-app/${{ env.APP_NAME }}
          chmod -R u+rwX .
          mkdir -p appinfo
          make appstore APP_NAME=${{ env.APP_NAME }} OCC="${{ github.workspace }}/../server/occ"

      - name: Upload app tarball to GitHub release
        uses: svenstaro/upload-release-action@v2
        id: attach_to_release
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ../release-app/${{ env.APP_NAME }}/build/artifacts/appstore/${{ env.APP_NAME }}.tar.gz
          asset_name: ${{ env.APP_NAME }}.tar.gz
          tag: ${{ github.ref }}
          overwrite: true

      - name: Upload app to Nextcloud App Store
        uses: R0Wi/nextcloud-appstore-push-action@v1
        with:
          app_name: ${{ env.APP_NAME }}
          appstore_token: ${{ secrets.APPSTORE_TOKEN }}
          download_url: ${{ steps.attach_to_release.outputs.browser_download_url }}
          app_private_key: ${{ secrets.APP_PRIVATE_KEY }}
          nightly: ${{ github.event.release.prerelease }}

      - name: Cleanup local cert/key
        run: rm -f ~/.nextcloud/certificates/*
